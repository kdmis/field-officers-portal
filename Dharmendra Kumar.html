<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Transfer List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            loadLottieAnimation();
            fetchData();
        });

        function loadLottieAnimation() {
            lottie.loadAnimation({
                container: document.getElementById("loadingAnimation"),
                renderer: "svg",
                loop: true,
                autoplay: true,
                path: "Progress-Bar-(Donut).json" // Ensure this file is served correctly
            });
        }

        function fetchData() {
            document.getElementById("loadingAnimation").style.display = "block";
            fetch("https://script.google.com/macros/s/AKfycbw-2YpJyhFxuYDHQVdxsUDwxQqzpizlNb1WqhjsHlICR8axc7mqnLFiWtA_1udVmldz/exec")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("loadingAnimation").style.display = "none";
                    let tableBody = document.getElementById("fileTableBody");
                    tableBody.innerHTML = "";
                    data.forEach(item => {
                        let row = `<tr class='border-b'>
                            <td class='p-2 text-center'>${item.district}</td>
                            <td class='p-2 text-center'>${item.party}</td>
                            <td class='p-2 text-center'>${item.uid}</td>
                            <td class='p-2 text-center'>
                                <button class="done-btn bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-3 rounded flex items-center justify-center"
                                    id="btn-${item.uid}" onclick="markAsDone('${item.uid}', this)">
                                    <span class="text">Mark Done</span>
                                    <div class="loader hidden w-4 h-4 ml-2"></div>
                                </button>
                            </td>
                        </tr>`;
                        tableBody.innerHTML += row;
                    });
                })
                .catch(error => console.error("Error fetching data:", error));
        }

        function markAsDone(uid, button) {
            let loader = button.querySelector(".loader");
            let text = button.querySelector(".text");

            text.style.display = "none"; // Hide text
            loader.classList.remove("hidden"); // Show loader
            
            fetch("https://script.google.com/macros/s/AKfycbw-2YpJyhFxuYDHQVdxsUDwxQqzpizlNb1WqhjsHlICR8axc7mqnLFiWtA_1udVmldz/exec", {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ uid: uid })
            })
            .then(() => {
                setTimeout(() => { // Simulating processing delay
                    text.innerText = "âœ” Done";
                    loader.classList.add("hidden"); 
                    text.style.display = "block"; // Show new text
                    button.classList.remove("bg-green-500", "hover:bg-green-700");
                    button.classList.add("bg-gray-500", "cursor-not-allowed");
                    button.disabled = true;
                }, 1000);
            })
            .catch(error => console.error("Error updating data:", error));
        }
    </script>
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center py-6">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">File Transfer List</h2>
    
    <!-- Lottie Animation for Loading -->
    <div id="loadingAnimation" class="mb-4 hidden"></div>

    <div class="overflow-x-auto w-full max-w-4xl">
        <table class="w-full bg-white shadow-md rounded-lg">
            <thead>
                <tr class="bg-gray-300">
                    <th class="p-2 text-center">District</th>
                    <th class="p-2 text-center">Party</th>
                    <th class="p-2 text-center">UID</th>
                    <th class="p-2 text-center">Action</th>
                </tr>
            </thead>
            <tbody id="fileTableBody" class="bg-white">
                <tr><td colspan="4" class="p-4 text-center text-gray-500">Loading data...</td></tr>
            </tbody>
        </table>
    </div>
</body>
</html>
